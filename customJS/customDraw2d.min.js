var myDraw2d={shapeDesc:{}};
draw2d.CustomCanvas=draw2d.Canvas.extend({NAME:"draw2d.CustomCanvas",init:function(a){this._super(a);this.layerRecs=[];this.nodeCirs=[];this.util=new myDraw2d.Util},onDragEnter:function(a,b){var d=$(a).data("shape"),c=$(b).find("img");"layerRec"===d?(this.util.DEFAULT_WIDTH_DOMIMAGE_LAYERREC||(this.util.DEFAULT_WIDTH_DOMIMAGE_LAYERREC=$(c).width()),this.util.DEFAULT_HEIGHT_DOMIMAGE_LAYERREC=$(c).height(),$(c).css("width",this.util.DEFAULT_WIDTH_LAYERREC*(1/this.getZoom())),$(c).css("height",this.util.DEFAULT_HEIGHT_LAYERREC*
(1/this.getZoom()))):"nodeCir"===d?(this.util.DEFAULT_DIAMETER_DOMIMAGE_NODECIR||(this.util.DEFAULT_DIAMETER_DOMIMAGE_NODECIR=$(c).width()),$(c).css("width",2*this.util.DEFAULT_RADIUS_NODECIR*(1/this.getZoom())),$(c).css("height",2*this.util.DEFAULT_RADIUS_NODECIR*(1/this.getZoom()))):console.log("Shape is not correct.")},onDragLeave:function(a,b){$(b).find("img");var d=$(a).data("shape");var c=$(b).find("img");"layerRec"===d?($(c).css("width",this.util.DEFAULT_WIDTH_DOMIMAGE_LAYERREC),$(c).css("height",
this.util.DEFAULT_HEIGHT_DOMIMAGE_LAYERREC)):"nodeCir"===d?($(c).css("width",this.util.DEFAULT_DIAMETER_DOMIMAGE_NODECIR),$(c).css("height",this.util.DEFAULT_DIAMETER_DOMIMAGE_NODECIR)):console.log("Shape is not correct.")},onDrop:function(a,b,d,c,e){a=$(a).data("shape");"layerRec"===a?(c=new myDraw2d.shapeDesc.LayerRectangle(c+this.util.DEFAULT_WIDTH_LAYERREC/2,e+this.util.DEFAULT_HEIGHT_LAYERREC/2,this.util.DEFAULT_WIDTH_LAYERREC,this.util.DEFAULT_HEIGHT_LAYERREC),(c=this.util.decideLayerCenterPos(c,
this.layerRecs,this.nodeCirs))?(a=new draw2d.shape.basic.LayerRectangle(this.util),c=new draw2d.command.CommandAdd(this,a,c.getX()-a.getWidth()/2,c.getY()-a.getHeight()/2),this.getCommandStack().execute(c),a.toBack(),this.layerRecs.push(a)):console.log("Cannot add overlapped layer")):"nodeCir"===a?(a=new draw2d.shape.basic.NodeCircle(this.util),c=new draw2d.command.CommandAdd(this,a,c,e),this.getCommandStack().execute(c),a._adjustPosition(!0),this.nodeCirs.push(a)):console.log("Shape is not correct.")}});
draw2d.policy.canvas.CustomFadeoutDecorationPolicy=draw2d.policy.canvas.FadeoutDecorationPolicy.extend({NAME:"draw2d.policy.canvas.CustomFadeoutDecorationPolicy",init:function(){this._super();this.alpha=1;this.DEFAULT_FADEOUT_DURATION=15;this.alphaDec=this.DEFAULT_ALPHA_DECREMENT;this.hidePortsCounter=this.DEFAULT_FADEOUT_DURATION;this.portDragging=!1},onMouseDrag:function(a,b,d,c,e,h,g){this.hidePortsCounter=9999}});
draw2d.policy.connection.CustomConnectionCreatePolicy=draw2d.policy.connection.ComposedConnectionCreatePolicy.extend({NAME:"draw2d.policy.connection.CustomConnectionCreatePolicy",init:function(){this._super([new draw2d.policy.connection.DragConnectionCreatePolicy({createConnection:function(){return new draw2d.Connection({stroke:3,outlineStroke:1,outlineColor:"#303030",color:"91B93E",router:new draw2d.layout.connection.SplineConnectionRouter})}}),new draw2d.policy.connection.ClickConnectionCreatePolicy({})])}});
draw2d.policy.canvas.CustomSingleSelectionPolicy=draw2d.policy.canvas.SingleSelectionPolicy.extend({NAME:"draw2d.policy.canvas.CustomSingleSelectionPolicy",init:function(){this._super()},onClick:function(a,b,d,c,e){null!=a&&"LayerRectangle"==a.name&&a.toBack()}});
draw2d.shape.basic.LayerRectangle=draw2d.shape.basic.Rectangle.extend({NAME:"draw2d.shape.basic.LayerRectangle",init:function(a){this._super({width:a.DEFAULT_WIDTH_LAYERREC,height:a.DEFAULT_HEIGHT_LAYERREC,bgColor:"#FFFFC7",radius:10,glow:!0,resizeable:!1});this.name="LayerRectangle";this.childNodes=[];this.preDragPosition=this.prePosition=null;this.initPolicies()},initPolicies:function(){this.installEditPolicy(new draw2d.policy.figure.SelectionFeedbackPolicy({onDrag:function(a,b){for(var d=b.getPosition(),
c=d.getX()-b.preDragPosition.getX(),e=d.getY()-b.preDragPosition.getY(),h=0;h<b.childNodes.length;++h){var g=b.childNodes[h];cmd=new draw2d.command.CommandMove(g);cmd.setPosition(g.getX()+c,g.getY()+e);a.getCommandStack().execute(cmd)}b.preDragPosition=d}}))},onDragStart:function(){this._super();this.prePosition=this.getPosition();this.preDragPosition=this.getPosition();this.toFront();for(var a=0;a<this.childNodes.length;++a)this.childNodes[a].toFront()},onDragEnd:function(){this._super();for(var a=
!1,b=this.getCanvas(),d=0;d<b.layerRecs.length;++d){var c=b.layerRecs[d];if(c!==this&&this.ifOverlapWithLayer(c)){a=!0;break}}if(!a)for(var e=new myDraw2d.shapeDesc.LayerRectangle(this.getX()+this.getWidth()/2,this.getY()+this.getHeight()/2,this.getWidth(),this.getHeight()),d=0;d<b.nodeCirs.length;++d)if(c=b.nodeCirs[d],!c.parentLayer&&(c=new myDraw2d.shapeDesc.NodeCircle(c.getX()+c.getDiameter()/2,c.getY()+c.getDiameter()/2,c.getDiameter()/2),b.util.ifLayerOverlapNode(e,c))){a=!0;break}if(a)for(d=
this.getPosition(),a=d.getX()-this.prePosition.getX(),e=d.getY()-this.prePosition.getY(),cmd=new draw2d.command.CommandMove(this),cmd.setPosition(this.prePosition),b.getCommandStack().execute(cmd),d=0;d<this.childNodes.length;++d)c=this.childNodes[d],cmd=new draw2d.command.CommandMove(c),cmd.setPosition(c.getX()-a,c.getY()-e),b.getCommandStack().execute(cmd);this.toBack()},ifOverlapWithLayer:function(a){var b=this.y+this.height/2,d=this.height,c=a.y+a.height/2,e=a.height;return Math.abs(a.x+a.width/
2-(this.x+this.width/2))>this.width/2+a.width/2+2||Math.abs(c-b)>d/2+e/2+2?!1:!0},getCenterPos:function(){return new draw2d.geo.Point(this.x+this.width/2,this.y+this.height/2)},ifPointInside:function(a,b){return a>=this.x&&a<=this.x+this.width&&b>=this.y&&b<=this.y+this.height?!0:!1}});
draw2d.shape.basic.NodeCircle=draw2d.shape.basic.Circle.extend({NAME:"draw2d.shape.basic.NodeCircle",init:function(a){this._super({diameter:2*a.DEFAULT_RADIUS_NODECIR,stroke:1,color:"#000000",bgColor:"#00A4D1",glow:!0,resizeable:!1});this.name="NodeCircle";this.preParentLayer=this.parentLayer=null;this.initPort();this.initPolicies()},initPort:function(){this.createPort("hybrid",new draw2d.layout.locator.LeftLocator);this.createPort("hybrid",new draw2d.layout.locator.RightLocator)},initPolicies:function(){this.installEditPolicy(new draw2d.policy.figure.SelectionFeedbackPolicy({}))},
onDragStart:function(){this._super();this.preParentLayer=this.parentLayer},onDragEnd:function(){this._super();this._adjustPosition(!0)},getCenterPos:function(){return new draw2d.geo.Point(this.x+this.width,this.y+this.width)},_adjustPosition:function(a){var b=this.getCanvas();this.parentLayer=this._decideParentLayer();if(this.preParentLayer===this.parentLayer&&this.parentLayer){var d=this.parentLayer.childNodes.indexOf(this),c=this._decideIndexInParentLayer();if(c==d||c==d+1){var e=null;if(0==d)e=
this.parentLayer.getY();else{var h=this.parentLayer.childNodes[d-1];e=h.getY()+h.getDiameter()}if(a){h=new Tweenable;var g=this;h.tween({from:{x:g.getX(),y:g.getY()},to:{x:this.parentLayer.getX()+this.parentLayer.getWidth()/2-g.getDiameter()/2,y:e+b.util.DEFAULT_INTERVAL_HEIGHT},duration:200,easing:"easeOutSine",step:function(a){cmd=new draw2d.command.CommandMove(g);cmd.setPosition(a.x,a.y);b.getCommandStack().execute(cmd)},finish:function(a){}})}else cmd=new draw2d.command.CommandMove(this),cmd.setPosition(this.parentLayer.getX()+
this.parentLayer.getWidth()/2-this.getDiameter()/2,e+b.util.DEFAULT_INTERVAL_HEIGHT),b.getCommandStack().execute(cmd)}else{e=b.util.DEFAULT_INTERVAL_HEIGHT+this.getDiameter();if(c>d)for(var f=d+1;f<c;++f)h=this.parentLayer.childNodes[f],cmd=new draw2d.command.CommandMove(h),cmd.setPosition(h.getX(),h.getY()-e),b.getCommandStack().execute(cmd);else for(f=d-1;f>=c;--f)h=this.parentLayer.childNodes[f],cmd=new draw2d.command.CommandMove(h),cmd.setPosition(h.getX(),h.getY()+e),b.getCommandStack().execute(cmd);
var k=this;setTimeout(function(){var e=null;c>d?(e=k.parentLayer.childNodes[c-1],e=e.getY()+e.getDiameter()+b.util.DEFAULT_INTERVAL_HEIGHT,k.parentLayer.childNodes.splice(d,1),k.parentLayer.childNodes.splice(c-1,0,k)):(e=k.parentLayer.childNodes[c].getY()-k.getDiameter()-b.util.DEFAULT_INTERVAL_HEIGHT,k.parentLayer.childNodes.splice(d,1),k.parentLayer.childNodes.splice(c,0,k));a?(new Tweenable).tween({from:{x:k.getX(),y:k.getY()},to:{x:k.parentLayer.getX()+k.parentLayer.getWidth()/2-k.getDiameter()/
2,y:e},duration:200,easing:"easeOutSine",step:function(a){cmd=new draw2d.command.CommandMove(k);cmd.setPosition(a.x,a.y);b.getCommandStack().execute(cmd)},finish:function(a){}}):(cmd=new draw2d.command.CommandMove(k),cmd.setPosition(k.parentLayer.getX()+k.parentLayer.getWidth()/2-k.getDiameter()/2,e),b.getCommandStack().execute(cmd))},20)}}else{if(this.preParentLayer){var l=this.preParentLayer.childNodes.indexOf(this);e=b.util.DEFAULT_INTERVAL_HEIGHT+this.getDiameter();1<this.preParentLayer.childNodes.length&&
(cmd=new draw2d.command.CommandResize(this.preParentLayer),cmd.setDimension(this.preParentLayer.getWidth(),this.preParentLayer.getHeight()-e),b.getCommandStack().execute(cmd));for(f=l+1;f<this.preParentLayer.childNodes.length;++f)h=this.preParentLayer.childNodes[f],cmd=new draw2d.command.CommandMove(h),cmd.setPosition(h.getX(),h.getY()-e),b.getCommandStack().execute(cmd);this.preParentLayer.childNodes.splice(l,1)}if(this.parentLayer){l=this._decideIndexInParentLayer();e=b.util.DEFAULT_INTERVAL_HEIGHT+
this.getDiameter();0<this.parentLayer.childNodes.length&&(cmd=new draw2d.command.CommandResize(this.parentLayer),cmd.setDimension(this.parentLayer.getWidth(),this.parentLayer.getHeight()+e),b.getCommandStack().execute(cmd));for(f=this.parentLayer.childNodes.length-1;f>=l;--f)h=this.parentLayer.childNodes[f],cmd=new draw2d.command.CommandMove(h),cmd.setPosition(h.getX(),h.getY()+e),b.getCommandStack().execute(cmd);e=null;0==l?e=this.parentLayer.getY():(h=this.parentLayer.childNodes[l-1],e=h.getY()+
h.getDiameter());a?(h=new Tweenable,g=this,h.tween({from:{x:g.getX(),y:g.getY()},to:{x:g.parentLayer.getX()+g.parentLayer.getWidth()/2-g.getDiameter()/2,y:e+b.util.DEFAULT_INTERVAL_HEIGHT},duration:200,easing:"easeOutSine",step:function(a){cmd=new draw2d.command.CommandMove(g);cmd.setPosition(a.x,a.y);b.getCommandStack().execute(cmd)},finish:function(a){}})):(cmd=new draw2d.command.CommandMove(this),cmd.setPosition(this.parentLayer.getX()+this.parentLayer.getWidth()/2-this.getDiameter()/2,e+b.util.DEFAULT_INTERVAL_HEIGHT),
b.getCommandStack().execute(cmd));this.parentLayer.childNodes.splice(l,0,this)}}},_decideParentLayer:function(){for(var a=this.getCanvas().layerRecs,b=a.length,d=null,c=0;c<b;++c){var e=a[c];if(e.ifPointInside(this.x+this.getDiameter()/2,this.y+this.getDiameter()/2)){d=e;break}}return d},_decideIndexInParentLayer:function(){if(!this.parentLayer)return null;var a=this.y+this.getDiameter()/2,b,d=this.parentLayer.childNodes;for(b=0;b<d.length;++b){var c=d[b];if(c!==this&&a<c.getY()+c.getDiameter()/2)break}return b}});
myDraw2d.Util=Class.extend({NAME:"myDraw2d.Util",init:function(){this.DEFAULT_WIDTH_LAYERREC=60;this.DEFAULT_INTERVAL_HEIGHT=25;this.DEFAULT_RADIUS_NODECIR=20;this.DEFAULT_HEIGHT_LAYERREC=2*this.DEFAULT_RADIUS_NODECIR+2*this.DEFAULT_INTERVAL_HEIGHT;this.DEFAULT_DIAMETER_DOMIMAGE_NODECIR=this.DEFAULT_HEIGHT_DOMIMAGE_LAYERREC=this.DEFAULT_WIDTH_DOMIMAGE_LAYERREC=null},decideLayerCenterPos:function(a,b,d){var c=null;var e=b.length;for(var h=d.length,g=0;g<e;++g){var f=b[g];f=new myDraw2d.shapeDesc.LayerRectangle(f.getX()+
f.getWidth()/2,f.getY()+f.getHeight()/2,f.getWidth(),f.getHeight());if(this.ifLayersOverlap(a,f)){c=f;break}}if(null===c){b=!1;for(g=0;g<h;++g)if(e=d[g],!e.parentLayer&&(e=new myDraw2d.shapeDesc.NodeCircle(e.getX()+e.getDiameter()/2,e.getY()+e.getDiameter()/2,e.getDiameter()/2),this.ifLayerOverlapNode(a,e))){b=!0;break}if(b)return console.log("no overlapped LayerRectangle but overlapped NodeCircle"),null;console.log("no overlapped LayerRectangle or NodeCircle");return new draw2d.geo.Point(a.centerX,
a.centerY)}g=a.centerX>c.centerX?a.width/2+c.width/2-(a.centerX-c.centerX)+5:c.centerX-a.centerX-(a.width/2+c.width/2)-5;console.log("center pos before applying offset: "+a.centerX+", "+a.centerY);a.centerX+=g;console.log("center pos after applying offset: "+a.centerX+", "+a.centerY);c=null;for(g=0;g<e;++g)if(f=b[g],f=new myDraw2d.shapeDesc.LayerRectangle(f.getX()+f.getWidth()/2,f.getY()+f.getHeight()/2,f.getWidth(),f.getHeight()),this.ifLayersOverlap(a,f)){c=f;break}if(c)return console.log("after shifting still overlaps with LayerRectangles"),
null;b=!1;for(g=0;g<h;++g)if(e=d[g],!e.parentLayer&&(e=new myDraw2d.shapeDesc.NodeCircle(e.getX()+e.getDiameter()/2,e.getY()+e.getDiameter()/2,e.getDiameter()/2),this.ifLayerOverlapNode(a,e))){b=!0;break}if(b)return console.log("after shifting no overlapped LayerRectangles but overlaps with NodeCircle"),null;console.log("after shifting no overlapped LayerRectangles or NodeCircle");return new draw2d.geo.Point(a.centerX,a.centerY)},ifLayersOverlap:function(a,b){return Math.abs(b.centerX-a.centerX)>
a.width/2+b.width/2+2||Math.abs(b.centerY-a.centerY)>a.height/2+b.height/2+2?!1:!0},ifLayerOverlapNode:function(a,b){if(a.ifPointInside(b.centerX,b.centerY))return!0;if(Math.abs(a.centerX-b.centerX)>a.width/2+b.radius+1||Math.abs(a.centerY-b.centerY)>a.height/2+b.radius+1)return!1;var d=null,c=null;b.centerX>a.centerX+a.width/2?b.centerY>a.centerY+a.height/2?(d=a.centerX+a.width/2,c=a.centerY+a.height/2):b.centerY<a.centerY-a.height/2&&(d=a.centerX+a.width/2,c=a.centerY-a.height/2):b.centerX<a.centerX-
a.width/2&&(b.centerY>a.centerY+a.height/2?(d=a.centerX-a.width/2,c=a.centerY+a.height/2):b.centerY<a.centerY-a.height/2&&(d=a.centerX-a.width/2,c=a.centerY-a.height/2));return d&&this.getDistance(d,c,b.centerX,b.centerY)>b.radius?!1:!0},getDistance:function(a,b,d,c){a-=d;b-=c;return Math.sqrt(a*a+b*b)}});
myDraw2d.shapeDesc.LayerRectangle=Class.extend({NAME:"myDraw2d.shapeDesc.LayerRectangle",init:function(a,b,d,c){this.centerX=a;this.centerY=b;this.width=d;this.height=c},ifPointInside:function(a,b){var d=this.width/2,c=this.height/2;return a>=this.centerX-d&&a<=this.centerX+d&&b>=this.centerY-c&&b<=this.centerY+c?!0:!1}});myDraw2d.shapeDesc.NodeCircle=Class.extend({NAME:"myDraw2d.shapeDesc.NodeCircle",init:function(a,b,d){this.centerX=a;this.centerY=b;this.radius=d}});